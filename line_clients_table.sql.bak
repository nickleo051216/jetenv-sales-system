-- ================================================
-- line_clients è¡¨ - LINE å®¢æˆ¶ç¶å®šè³‡æ–™
-- ç”¨é€”ï¼šå„²å­˜ç°½ç´„å®¢æˆ¶çš„ LINE User IDï¼Œç”¨æ–¼æ¨æ’­é€šçŸ¥
-- ================================================

-- 1. å»ºç«‹è³‡æ–™è¡¨
CREATE TABLE IF NOT EXISTS line_clients (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  
  -- LINE è³‡è¨Š
  line_user_id TEXT UNIQUE NOT NULL,    -- LINE User ID (Ué–‹é ­ï¼Œ33å­—å…ƒ)
  line_display_name TEXT,                -- LINE é¡¯ç¤ºåç¨±
  
  -- å®¢æˆ¶è³‡è¨Šï¼ˆé—œè¯ç”¨ï¼‰
  uniformno TEXT NOT NULL,               -- çµ±ä¸€ç·¨è™Ÿï¼ˆç”¨ä¾† JOIN è¨±å¯è­‰è³‡æ–™ï¼‰
  fac_name TEXT,                         -- å·¥å» åç¨±
  quote_number TEXT,                     -- å ±åƒ¹å–®å–®è™Ÿï¼ˆé©—è­‰ç”¨ï¼‰
  
  -- é€šçŸ¥è¨­å®š
  notify_180days BOOLEAN DEFAULT TRUE,   -- 180å¤©å‰é€šçŸ¥
  notify_90days BOOLEAN DEFAULT TRUE,    -- 90å¤©å‰é€šçŸ¥
  notify_30days BOOLEAN DEFAULT TRUE,    -- 30å¤©å‰é€šçŸ¥  
  notify_7days BOOLEAN DEFAULT TRUE,     -- 7å¤©å‰é€šçŸ¥
  is_active BOOLEAN DEFAULT TRUE,        -- æ˜¯å¦å•Ÿç”¨é€šçŸ¥
  
  -- æ™‚é–“æˆ³
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 2. å»ºç«‹ç´¢å¼•ï¼ˆåŠ å¿«æŸ¥è©¢é€Ÿåº¦ï¼‰
CREATE INDEX IF NOT EXISTS idx_line_clients_uniformno ON line_clients(uniformno);
CREATE INDEX IF NOT EXISTS idx_line_clients_line_user_id ON line_clients(line_user_id);
CREATE INDEX IF NOT EXISTS idx_line_clients_is_active ON line_clients(is_active);

-- 3. å•Ÿç”¨ RLS (Row Level Security)
ALTER TABLE line_clients ENABLE ROW LEVEL SECURITY;

-- 4. å»ºç«‹ RLS æ”¿ç­– - å…è¨±æ‰€æœ‰äººè®€å–
CREATE POLICY "Allow public select on line_clients" 
ON line_clients 
FOR SELECT 
USING (true);

-- 5. å»ºç«‹ RLS æ”¿ç­– - å…è¨± Service Role å®Œå…¨å­˜å–ï¼ˆn8n åŒæ­¥ç”¨ï¼‰
CREATE POLICY "Allow all for service role on line_clients" 
ON line_clients 
FOR ALL 
USING (true)
WITH CHECK (true);

-- ================================================
-- æ¸¬è©¦è³‡æ–™ï¼ˆç”¨ä½ è‡ªå·±çš„ LINE User ID æ¸¬è©¦ï¼‰
-- ================================================
-- INSERT INTO line_clients (line_user_id, line_display_name, uniformno, fac_name, quote_number)
-- VALUES ('Uä½ çš„LINE_USER_ID', 'Nick', '12345678', 'æ¸¬è©¦å·¥å» ', 'Q2024120001');

-- ================================================
-- æŸ¥è©¢å³å°‡åˆ°æœŸè¨±å¯è­‰ + åªæ¨çµ¦ç¶å®šå®¢æˆ¶çš„å®Œæ•´ SQL
-- ================================================
/*
WITH expiring_permits AS (
  -- ğŸ’§ æ°´æ±¡è¨±å¯è­‰
  SELECT 
    wp.ban as uniformno,
    wp.fac_name,
    wp.per_no,
    wp.per_edate as expiry_date,
    'water' as permit_type,
    'ğŸ’§ æ°´æ±¡è¨±å¯' as permit_name
  FROM water_permits wp
  WHERE wp.per_edate BETWEEN CURRENT_DATE AND (CURRENT_DATE + INTERVAL '180 days')
  
  UNION ALL
  
  -- â˜¢ï¸ æ¯’åŒ–ç‰©è¨±å¯è­‰
  SELECT 
    COALESCE(tp.unino, tp.ban) as uniformno,
    tp.fac_name,
    tp.per_no,
    tp.edate as expiry_date,
    'toxic' as permit_type,
    'â˜¢ï¸ æ¯’åŒ–ç‰©è¨±å¯' as permit_name
  FROM toxic_permits tp
  WHERE tp.edate BETWEEN CURRENT_DATE AND (CURRENT_DATE + INTERVAL '180 days')
  
  UNION ALL
  
  -- ğŸ’¨ ç©ºæ±¡è¨±å¯è­‰
  SELECT 
    f.uniformno,
    f.facilityname as fac_name,
    NULL as per_no,
    f.airreleasedate as expiry_date,
    'air' as permit_type,
    'ğŸ’¨ ç©ºæ±¡è¨±å¯' as permit_name
  FROM factories f
  WHERE f.airreleasedate BETWEEN CURRENT_DATE AND (CURRENT_DATE + INTERVAL '180 days')
  
  UNION ALL
  
  -- ğŸ—‘ï¸ å»¢æ¸…æ›¸
  SELECT 
    f.uniformno,
    f.facilityname as fac_name,
    NULL as per_no,
    f.wastereleasedate as expiry_date,
    'waste' as permit_type,
    'ğŸ—‘ï¸ å»¢æ¸…æ›¸' as permit_name
  FROM factories f
  WHERE f.wastereleasedate BETWEEN CURRENT_DATE AND (CURRENT_DATE + INTERVAL '180 days')
)
SELECT 
  lc.line_user_id,           -- æ¨æ’­å°è±¡
  lc.line_display_name,
  ep.uniformno,
  ep.fac_name,
  ep.permit_type,
  ep.permit_name,
  ep.expiry_date,
  (ep.expiry_date - CURRENT_DATE) as days_until_expiry
FROM expiring_permits ep
INNER JOIN line_clients lc ON ep.uniformno = lc.uniformno
WHERE lc.is_active = TRUE
ORDER BY ep.expiry_date ASC;
*/
