# 空污操作許可證爬蟲 (Air Permit Scraper)

此腳本用於從 [環境部空污許可管理資訊系統](https://aodmis.moenv.gov.tw/opendata/#/lq) 爬取工廠的空污許可證到期日資料。

## 檔案位置
`scripts/air_permit_scraper_semi.js`

## 執行方式
```bash
node scripts/air_permit_scraper_semi.js
```
*依賴*: `puppeteer`, `exceljs`

## 核心邏輯與輸出格式 (重要)

使用者規定：**所有爬蟲結果必須輸出到同一個 Excel 檔案中。**

### 輸出檔案
`data/air_permits.xlsx`

### 分頁結構 (Sheet Structure)
Excel 檔案包含兩種類型的分頁：

1.  **📊 總表 (Summary)**
    *   **位置**: 固定為 **第一個分頁**。
    *   **功能**: 累積所有爬取過的資料。每次執行爬蟲，新的資料都會被**追加 (Append)** 到此表中。
    *   **欄位**: 包含所有許可證欄位，並額外增加 `district` (地區) 欄位以識別來源。
    *   **樣式**: 藍色標籤 (Blue Tab)。

2.  **📄 地區分頁 (District Sheets)**
    *   **命名**: 以爬取的「鄉鎮區」命名 (例如：`土城區`, `樹林區`, `五股區`)。
    *   **功能**: 該次爬取的該地區完整資料。
    *   **處理**: 
        *   每次爬取一個新地區，會建立一個新的分頁。
        *   如果該地區分頁已存在，系統會自動加上時間戳記 (例如 `土城區_1430`) 以避免覆蓋舊資料，但通常目的是保留各區的最新快照。

## 爬蟲流程
1.  **啟動**: 開啟瀏覽器並導向目標網站。
2.  **手動輸入**: 使用者需手動選擇「縣市」與「鄉鎮區」並按下查詢。
3.  **自動處理**: 
    *   腳本偵測到查詢後，會自動檢查並勾選「許可」選項。
    *   自動翻頁並擷取所有工廠的 EMS No.。
    *   逐一進入工廠詳情頁面，抓取許可證資料 (尤其是效期 `expiry_date`)。
4.  **儲存**: 
    *   讀取現有 `air_permits.xlsx` (如果不存則建立)。
    *   將資料追加到「總表」。
    *   將資料寫入新的「地區分頁」。

## 維護注意事項
*   **不要更改輸出邏輯**：保持「總表 + 地區分頁」的結構。
*   **總表位置**：程式碼中包含邏輯確保「總表」永遠被移動到第一順位。
*   **ExcelJS**: 使用 `exceljs` 套件來處理 Excel 的讀寫操作。
