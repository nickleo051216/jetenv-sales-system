{
    "name": "Sync Air Permits from Google Sheets",
    "nodes": [
        {
            "parameters": {
                "httpMethod": "POST",
                "path": "sync-air-permits",
                "responseMode": "responseNode",
                "options": {}
            },
            "id": "webhook-trigger",
            "name": "Webhook",
            "type": "n8n-nodes-base.webhook",
            "typeVersion": 2,
            "position": [
                250,
                300
            ],
            "webhookId": "sync-air-permits"
        },
        {
            "parameters": {
                "jsCode": "// å¾ Webhook å–å¾—è³‡æ–™\nconst input = $input.first().json;\nconst records = input.records || [];\nconst sheetName = input.sheetName || 'Unknown';\n\nconsole.log(`ğŸ“¥ æ”¶åˆ° ${records.length} ç­†è³‡æ–™ï¼Œä¾†è‡ªå·¥ä½œè¡¨ï¼š${sheetName}`);\n\nif (records.length === 0) {\n  throw new Error('æ²’æœ‰æ”¶åˆ°ä»»ä½•è³‡æ–™');\n}\n\n// è½‰æ›è³‡æ–™æ ¼å¼ï¼Œæº–å‚™ Upsert\nconst formatted = records.map(r => ({\n  ems_no: r.ems_no || '',\n  county: r.county || '',\n  company_name: r.company_name || '',\n  address: r.address || '',\n  process_id: '',\n  process_name: '',\n  category: r.category || 'æ“ä½œ',\n  permit_no: '',\n  effective_date: null,\n  expiry_date: r.expiry_date || ''  // å·²ç¶“æ˜¯ YYYY-MM-DD æ ¼å¼\n}));\n\nreturn formatted.map(item => ({ json: item }));"
            },
            "id": "code-transform",
            "name": "æ ¼å¼è½‰æ›",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                470,
                300
            ]
        },
        {
            "parameters": {
                "operation": "upsert",
                "tableId": "air_permits",
                "conflictColumns": [
                    "ems_no"
                ],
                "fieldsToSend": {
                    "fieldMappings": [
                        {
                            "fieldName": "ems_no",
                            "fieldValue": "={{ $json.ems_no }}"
                        },
                        {
                            "fieldName": "county",
                            "fieldValue": "={{ $json.county }}"
                        },
                        {
                            "fieldName": "company_name",
                            "fieldValue": "={{ $json.company_name }}"
                        },
                        {
                            "fieldName": "address",
                            "fieldValue": "={{ $json.address }}"
                        },
                        {
                            "fieldName": "process_id",
                            "fieldValue": "={{ $json.process_id }}"
                        },
                        {
                            "fieldName": "process_name",
                            "fieldValue": "={{ $json.process_name }}"
                        },
                        {
                            "fieldName": "category",
                            "fieldValue": "={{ $json.category }}"
                        },
                        {
                            "fieldName": "permit_no",
                            "fieldValue": "={{ $json.permit_no }}"
                        },
                        {
                            "fieldName": "expiry_date",
                            "fieldValue": "={{ $json.expiry_date }}"
                        }
                    ]
                }
            },
            "id": "supabase-upsert",
            "name": "Upsert Supabase",
            "type": "n8n-nodes-base.supabase",
            "typeVersion": 1,
            "position": [
                690,
                300
            ],
            "credentials": {
                "supabaseApi": {
                    "id": "RnsK9FrQBnMRc38T",
                    "name": "nickleo051216 jet"
                }
            }
        },
        {
            "parameters": {
                "jsCode": "// çµ±è¨ˆçµæœ\nconst items = $input.all();\nconst successCount = items.length;\n\nreturn [{\n  json: {\n    success: true,\n    message: `âœ… æˆåŠŸåŒæ­¥ ${successCount} ç­†è³‡æ–™`,\n    count: successCount,\n    timestamp: new Date().toISOString()\n  }\n}];"
            },
            "id": "code-result",
            "name": "çµ±è¨ˆçµæœ",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                910,
                300
            ]
        },
        {
            "parameters": {
                "respondWith": "json",
                "responseBody": "={{ $json }}",
                "options": {}
            },
            "id": "respond-success",
            "name": "å›æ‡‰æˆåŠŸ",
            "type": "n8n-nodes-base.respondToWebhook",
            "typeVersion": 1.1,
            "position": [
                1130,
                300
            ]
        },
        {
            "parameters": {
                "respondWith": "json",
                "responseBody": "={\"success\": false, \"error\": \"{{ $json.error.message }}\"}",
                "options": {
                    "responseCode": 500
                }
            },
            "id": "respond-error",
            "name": "å›æ‡‰éŒ¯èª¤",
            "type": "n8n-nodes-base.respondToWebhook",
            "typeVersion": 1.1,
            "position": [
                910,
                500
            ]
        }
    ],
    "connections": {
        "Webhook": {
            "main": [
                [
                    {
                        "node": "æ ¼å¼è½‰æ›",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "æ ¼å¼è½‰æ›": {
            "main": [
                [
                    {
                        "node": "Upsert Supabase",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Upsert Supabase": {
            "main": [
                [
                    {
                        "node": "çµ±è¨ˆçµæœ",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "çµ±è¨ˆçµæœ": {
            "main": [
                [
                    {
                        "node": "å›æ‡‰æˆåŠŸ",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        }
    },
    "settings": {
        "executionOrder": "v1"
    },
    "staticData": null,
    "meta": {
        "templateCredsSetupCompleted": true
    },
    "pinData": {},
    "tags": []
}